# HÆ°á»›ng dáº«n Ghi tháº» NFC Sinh viÃªn

## Tá»•ng quan

TÃ­nh nÄƒng cho phÃ©p sinh viÃªn tá»± ghi thÃ´ng tin cÃ¡ nhÃ¢n (MSSV, Há» tÃªn) lÃªn tháº» NFC mÃ  khÃ´ng cáº§n admin, váº«n Ä‘áº£m báº£o tÃ­nh báº£o máº­t thÃ´ng qua chá»¯ kÃ½ sá»‘ (HMAC-SHA256).

## Cáº¥u trÃºc dá»¯ liá»‡u trÃªn tháº»

Dá»¯ liá»‡u Ä‘Æ°á»£c ghi lÃªn tháº» NFC theo Ä‘á»‹nh dáº¡ng:

```
STUDENT_CARD|<MSSV>|<Há» TÃªn>|<Card ID>|<Signature>
```

**VÃ­ dá»¥:**
```
STUDENT_CARD|2211001234|Nguyen Van A|CARD-12345678-1699123456789|a1b2c3d4e5f6g7h8
```

### CÃ¡c thÃ nh pháº§n:

1. **STUDENT_CARD**: Prefix cá»‘ Ä‘á»‹nh Ä‘á»ƒ nháº­n diá»‡n tháº» sinh viÃªn
2. **MSSV**: MÃ£ sá»‘ sinh viÃªn tá»« tÃ i khoáº£n
3. **Há» TÃªn**: TÃªn Ä‘áº§y Ä‘á»§ cá»§a sinh viÃªn
4. **Card ID**: MÃ£ Ä‘á»‹nh danh duy nháº¥t cá»§a tháº» (generated by backend)
5. **Signature**: Chá»¯ kÃ½ sá»‘ HMAC-SHA256 (16 kÃ½ tá»± Ä‘áº§u) Ä‘á»ƒ xÃ¡c thá»±c

### Báº£o máº­t

- **Signature** Ä‘Æ°á»£c táº¡o báº±ng HMAC-SHA256:
  ```
  HMAC-SHA256(MSSV + Há» TÃªn + Card ID, NFC_SECURITY_KEY)
  ```
- Secret key Ä‘Æ°á»£c lÆ°u trá»¯ trong `.env` cá»§a backend
- Má»—i tháº» cÃ³ signature riÃªng, khÃ´ng thá»ƒ giáº£ máº¡o hoáº·c sao chÃ©p

## Luá»“ng hoáº¡t Ä‘á»™ng

### 1. Sinh viÃªn yÃªu cáº§u ghi tháº»

**Mobile App:**
1. Sinh viÃªn vÃ o **Home** > Nháº¥n **"Ghi tháº»"** (hoáº·c **Profile** > **Ghi tháº» sinh viÃªn**)
2. App tá»± Ä‘á»™ng gá»i API: `GET /api/cards/generate-write-data`
3. ThÃ´ng tin sinh viÃªn Ä‘Æ°á»£c hiá»ƒn thá»‹ tá»± Ä‘á»™ng

**Backend:**
```javascript
// cardService.js - generateCardWriteData()
1. Láº¥y thÃ´ng tin user tá»« database
2. Táº¡o Card ID duy nháº¥t
3. Generate signature: HMAC-SHA256(studentId + fullName + cardId)
4. Tráº£ vá» dá»¯ liá»‡u ghi tháº»
```

**Response:**
```json
{
  "success": true,
  "data": {
    "writeData": "STUDENT_CARD|2211001234|Nguyen Van A|CARD-...|...",
    "studentId": "2211001234",
    "fullName": "Nguyen Van A",
    "cardId": "CARD-12345678-1699123456789",
    "signature": "a1b2c3d4e5f6g7h8",
    "instructions": [
      "Cháº¡m tháº» NFC vÃ o Ä‘iá»‡n thoáº¡i",
      "Dá»¯ liá»‡u sáº½ Ä‘Æ°á»£c ghi tá»± Ä‘á»™ng",
      "Tháº» cÃ³ thá»ƒ dÃ¹ng Ä‘á»ƒ thanh toÃ¡n sau khi liÃªn káº¿t"
    ]
  }
}
```

### 2. Ghi dá»¯ liá»‡u lÃªn tháº» NFC

**Mobile App:**
1. Sinh viÃªn nháº¥n **"Ghi tháº» NFC"**
2. Cháº¡m tháº» NFC vÃ o Ä‘iá»‡n thoáº¡i
3. App ghi NDEF Text Record vá»›i `writeData`
4. Láº¥y UID cá»§a tháº»
5. Tá»± Ä‘á»™ng liÃªn káº¿t tháº» vá»›i tÃ i khoáº£n: `POST /api/cards`

**Flutter Code:**
```dart
// write_card_controller.dart
await nfc.FlutterNfcKit.poll();
final record = ndef.TextRecord(
  language: 'en',
  text: cardData.writeData,
);
await nfc.FlutterNfcKit.writeNDEFRecords([record]);

// Auto link card
await cardRepository.linkCard(
  uid: tag.id,
  alias: 'Tháº» sinh viÃªn ${cardData.studentId}',
  makePrimary: true,
);
```

### 3. XÃ¡c thá»±c tháº» khi thanh toÃ¡n (Future)

**Backend verify:**
```javascript
// cardService.js - verifyCardData()
1. Äá»c dá»¯ liá»‡u tá»« tháº» NFC
2. Parse: STUDENT_CARD|MSSV|Name|CardID|Signature
3. TÃ­nh signature mong Ä‘á»£i: HMAC-SHA256(MSSV + Name + CardID)
4. So sÃ¡nh signature
5. Náº¿u há»£p lá»‡: cho phÃ©p thanh toÃ¡n
```

## API Endpoints

### 1. Generate Card Write Data

**Endpoint:** `GET /api/cards/generate-write-data`

**Headers:**
```
Authorization: Bearer <access_token>
```

**Response:**
```json
{
  "success": true,
  "message": "Dá»¯ liá»‡u ghi tháº» Ä‘Ã£ Ä‘Æ°á»£c táº¡o",
  "data": {
    "writeData": "STUDENT_CARD|...",
    "studentId": "2211001234",
    "fullName": "Nguyen Van A",
    "cardId": "CARD-...",
    "signature": "...",
    "instructions": [...]
  }
}
```

### 2. Link Card (Auto called after write)

**Endpoint:** `POST /api/cards`

**Request:**
```json
{
  "uid": "04:AB:CD:EF:12:34:56",
  "alias": "Tháº» sinh viÃªn 2211001234",
  "makePrimary": true
}
```

## Sá»­ dá»¥ng trong Mobile App

### 1. CÃ i Ä‘áº·t dependencies

ÄÃ£ cÃ³ sáºµn trong `pubspec.yaml`:
```yaml
dependencies:
  flutter_nfc_kit: ^3.3.1
  ndef: ^0.3.1
```

### 2. Permissions

**Android (`android/app/src/main/AndroidManifest.xml`):**
```xml
<uses-permission android:name="android.permission.NFC" />
<uses-feature android:name="android.hardware.nfc" android:required="false" />
```

**iOS (`ios/Runner/Info.plist`):**
```xml
<key>NFCReaderUsageDescription</key>
<string>App cáº§n truy cáº­p NFC Ä‘á»ƒ Ä‘á»c vÃ  ghi tháº» sinh viÃªn</string>
<key>com.apple.developer.nfc.readersession.formats</key>
<array>
    <string>NDEF</string>
    <string>TAG</string>
</array>
```

### 3. Navigation

**Tá»« Profile Screen:**
```dart
Profile > Ghi tháº» sinh viÃªn > WriteCardScreen
```

**Route:** `/write-card`

## Testing

### 1. Test API

```bash
# Login Ä‘á»ƒ láº¥y token
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "login": "2211001234",
    "password": "123456"
  }'

# Generate write data
curl http://localhost:3000/api/cards/generate-write-data \
  -H "Authorization: Bearer <access_token>"
```

### 2. Test Mobile App

1. Äáº£m báº£o backend Ä‘ang cháº¡y
2. Login vÃ o app
3. Tá»« Home screen, nháº¥n button "Ghi tháº»" (hoáº·c Profile > Ghi tháº» sinh viÃªn)
4. **Tá»± Ä‘á»™ng:** App sáº½ load thÃ´ng tin sinh viÃªn (MSSV, TÃªn, MÃ£ tháº»)
5. Kiá»ƒm tra thÃ´ng tin hiá»ƒn thá»‹ Ä‘Ãºng
6. Chuáº©n bá»‹ tháº» NFC trá»‘ng hoáº·c cÃ³ thá»ƒ ghi Ä‘Ã¨
7. Nháº¥n button to mÃ u xanh **"Cháº¡m tháº» Ä‘á»ƒ ghi"**
8. Cháº¡m tháº» vÃ o Ä‘iá»‡n thoáº¡i vÃ  giá»¯ nguyÃªn
9. Kiá»ƒm tra logs: "Ghi tháº» thÃ nh cÃ´ng!"
10. Tháº» tá»± Ä‘á»™ng liÃªn káº¿t vá»›i tÃ i khoáº£n

### 3. Verify tháº» Ä‘Ã£ ghi

**Äá»c láº¡i tháº»:**
- VÃ o mÃ n hÃ¬nh NFC screen cÅ©
- Nháº¥n "Äá»c tháº»"
- Cháº¡m tháº» vÃ o Ä‘iá»‡n thoáº¡i
- Sáº½ tháº¥y: `VÄƒn báº£n: STUDENT_CARD|...|...`

**Kiá»ƒm tra trong database:**
```javascript
// MongoDB
db.cards.find({ userId: ObjectId("...") })
```

## Troubleshooting

### 1. "KhÃ´ng thá»ƒ táº¡o dá»¯ liá»‡u"

**NguyÃªn nhÃ¢n:**
- Backend khÃ´ng cháº¡y
- Token háº¿t háº¡n
- User khÃ´ng cÃ³ profile (firstName, lastName)

**Giáº£i phÃ¡p:**
- Kiá»ƒm tra backend logs
- Re-login
- Cáº­p nháº­t profile trong database

### 2. "Lá»—i NFC: Tag was lost"

**NguyÃªn nhÃ¢n:**
- Tháº» rá»i xa Ä‘iá»‡n thoáº¡i quÃ¡ sá»›m
- Tháº» khÃ´ng tÆ°Æ¡ng thÃ­ch

**Giáº£i phÃ¡p:**
- Giá»¯ tháº» sÃ¡t Ä‘iá»‡n thoáº¡i cho Ä‘áº¿n khi hoÃ n táº¥t
- DÃ¹ng tháº» NDEF-compatible (NTAG, Mifare Classic, etc.)

### 3. "Ghi tháº» thÃ nh cÃ´ng nhÆ°ng liÃªn káº¿t tháº¥t báº¡i"

**NguyÃªn nhÃ¢n:**
- UID Ä‘Ã£ Ä‘Æ°á»£c liÃªn káº¿t vá»›i tÃ i khoáº£n khÃ¡c
- Network error khi call API link

**Giáº£i phÃ¡p:**
- LiÃªn káº¿t thá»§ cÃ´ng trong "Quáº£n lÃ½ tháº»"
- Hoáº·c dÃ¹ng tháº» khÃ¡c

### 4. Tháº» Ä‘Ã£ ghi nhÆ°ng khÃ´ng Ä‘á»c Ä‘Æ°á»£c

**NguyÃªn nhÃ¢n:**
- Tháº» bá»‹ lock
- Dá»¯ liá»‡u ghi bá»‹ lá»—i

**Giáº£i phÃ¡p:**
- DÃ¹ng app NFC Tools Ä‘á»ƒ kiá»ƒm tra tháº»
- Format tháº» vÃ  ghi láº¡i

## Security Considerations

### âœ… Báº£o máº­t

1. **Signature verification**: Má»—i tháº» cÃ³ chá»¯ kÃ½ sá»‘ unique
2. **Secret key**: ÄÆ°á»£c lÆ°u an toÃ n trong backend `.env`
3. **KhÃ´ng thá»ƒ giáº£ máº¡o**: KhÃ´ng thá»ƒ táº¡o signature há»£p lá»‡ mÃ  khÃ´ng cÃ³ secret key
4. **Card ID unique**: Má»—i láº§n ghi táº¡o Card ID má»›i

### âš ï¸ LÆ°u Ã½

1. **Tháº» cÃ³ thá»ƒ Ä‘á»c Ä‘Æ°á»£c**: Báº¥t ká»³ ai cÃ³ NFC reader Ä‘á»u cÃ³ thá»ƒ Ä‘á»c thÃ´ng tin cÃ´ng khai (MSSV, TÃªn)
2. **KhÃ´ng lÆ°u máº­t kháº©u**: KhÃ´ng bao giá» ghi máº­t kháº©u lÃªn tháº» NFC
3. **Physical security**: Tháº» cÃ³ thá»ƒ bá»‹ máº¥t/Ä‘Ã¡nh cáº¯p - cáº§n cÃ³ cÆ¡ cháº¿ lock/unlock tháº»

### ğŸ”’ Best Practices

1. **Rotate security key**: Äá»‹nh ká»³ thay Ä‘á»•i `NFC_SECURITY_KEY`
2. **Monitor suspicious activities**: Log táº¥t cáº£ verify attempts
3. **Rate limiting**: Giá»›i háº¡n sá»‘ láº§n ghi/verify tháº»
4. **Two-factor**: CÃ³ thá»ƒ thÃªm PIN hoáº·c biometric khi dÃ¹ng tháº» thanh toÃ¡n

## Future Enhancements

1. **MÃ£ hÃ³a dá»¯ liá»‡u tháº»**: Encrypt toÃ n bá»™ `writeData` thay vÃ¬ chá»‰ signature
2. **QR Code fallback**: Náº¿u khÃ´ng cÃ³ NFC, cÃ³ thá»ƒ dÃ¹ng QR code
3. **Multiple cards**: Cho phÃ©p sinh viÃªn cÃ³ nhiá»u tháº»
4. **Card expiry**: Tháº» cÃ³ thá»i háº¡n sá»­ dá»¥ng
5. **Admin verify portal**: Web interface Ä‘á»ƒ admin verify tháº»
6. **Offline verify**: Cache signature Ä‘á»ƒ verify khi khÃ´ng cÃ³ máº¡ng

## Files Changed

### Backend
- `backend/src/services/cardService.js` - Added `generateCardWriteData()` and `verifyCardData()`
- `backend/src/controllers/cardController.js` - Added `generateWriteData()`
- `backend/src/routes/cardRoutes.js` - Added `GET /generate-write-data`

### Mobile App
- `mobile-app/nfc_app/lib/features/card/domain/card_write_data.dart` - New domain model
- `mobile-app/nfc_app/lib/features/card/infrastructure/card_repository.dart` - New repository
- `mobile-app/nfc_app/lib/features/card/application/write_card_controller.dart` - New controller
- `mobile-app/nfc_app/lib/features/card/presentation/write_card_screen.dart` - New screen
- `mobile-app/nfc_app/lib/router/app_router.dart` - Added `/write-card` route
- `mobile-app/nfc_app/lib/features/profile/presentation/profile_screen.dart` - Added navigation button

## Environment Variables

Cáº§n thiáº¿t trong `.env`:
```env
NFC_SECURITY_KEY=your_super_secret_nfc_key_change_in_production
```

**âš ï¸ Important:** Thay Ä‘á»•i `NFC_SECURITY_KEY` trong production!

## Support

Náº¿u gáº·p váº¥n Ä‘á», cung cáº¥p:
1. Backend logs khi generate write data
2. Mobile app logs (flutter logs)
3. Loáº¡i tháº» NFC Ä‘ang dÃ¹ng
4. Error message cá»¥ thá»ƒ
